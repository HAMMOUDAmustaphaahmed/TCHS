<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>TCHS Dashboard</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <!-- Favicon -->
<link href="{{ url_for('static', filename='img/favicon.ico') }}" rel="icon">

<!-- Google Web Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Icon Font Stylesheet -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

<!-- Libraries Stylesheet -->
<link href="{{ url_for('static', filename='lib/owlcarousel/assets/owl.carousel.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css') }}" rel="stylesheet">

<!-- Customized Bootstrap Stylesheet -->
<link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">

<!-- Template Stylesheet -->
<link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">

</head>

<body>
        

        <!-- Sidebar Start -->
        {% include 'sidebar.html' %}
        <!-- Sidebar End -->


        <!-- Content Start -->
        <div class="content">
            <!-- Navbar Start -->
            <nav class="navbar navbar-expand bg-light navbar-light sticky-top px-4 py-0">
                <a href="index.html" class="navbar-brand d-flex d-lg-none me-4">
                    <h2 class="text-primary mb-0"></h2>
                </a>
                <a href="#" class="sidebar-toggler flex-shrink-0">
                    <i class="fa fa-bars"></i>
                </a>

                

                

                
            </nav>
            <!-- Navbar End -->

<!-- Sale & Revenue Start -->
<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-sm-6 col-xl-3">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <i class="fa fa-wallet fa-3x text-primary"></i>
                <div class="ms-3">
                    <p class="mb-2">Total Collect√©</p>
                    <h6 class="mb-0">{{ total_collecte }} TND</h6>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <i class="fa fa-chart-bar fa-3x text-primary"></i>
                <div class="ms-3">
                    <p class="mb-2">Total Restant</p>
                    <h6 class="mb-0">{{ total_reste }} TND</h6>
                </div>
            </div>
        </div>
        
        <div class="col-sm-6 col-xl-3">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <i class="fa fa-file-invoice-dollar fa-3x text-primary"></i>
                <div class="ms-3">
                    <p class="mb-2">Total Pr√©vue</p>
                    <h6 class="mb-0">{{ total_collecte + total_reste }} TND</h6>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <i class="fa fa-list-alt fa-3x text-primary"></i>
                <div class="ms-3">
                    <p class="mb-2">Total Transactions</p>
                    <h6 class="mb-0">{{ paiements_count }}</h6>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Sale & Revenue End -->
<!-- Adherents Indicators Start -->
<div class="container-fluid pt-4 px-4">
    <div class="bg-light rounded p-4">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h6 class="mb-0">Indicateurs Adh√©rents</h6>
            <button class="btn btn-sm btn-outline-primary" onclick="resetFilters()">R√©initialiser</button>
        </div>
        
        <!-- Filtres -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="mb-3">Filtrer par Type d'Abonnement:</h6>
                <div id="typeAbonnementFilters" class="d-flex flex-wrap gap-2">
                    <!-- Les checkboxes seront g√©n√©r√©es dynamiquement -->
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="mb-3">Filtrer par Groupe:</h6>
                <div id="groupeFilters" class="d-flex flex-wrap gap-2">
                    <!-- Les checkboxes seront g√©n√©r√©es dynamiquement -->
                </div>
            </div>
        </div>
        
        <!-- Indicateur principal -->
        <div class="row">
            <div class="col-12">
                <div class="bg-primary text-white rounded p-4 text-center">
                    <i class="fa fa-users fa-3x mb-3"></i>
                    <h2 id="totalAdherents" class="mb-2">0</h2>
                    <p class="mb-0">Adh√©rents S√©lectionn√©s</p>
                    <small id="filterStatus" class="text-light">Tous les adh√©rents</small>
                </div>
            </div>
        </div>
        
        <!-- Statistiques d√©taill√©es -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="bg-white rounded p-3">
                    <h6 class="mb-3">R√©partition par Type D'Abonnement</h6>
                    <div id="typeStats"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="bg-white rounded p-3">
                    <h6 class="mb-3">R√©partition par Groupe</h6>
                    <div id="groupeStats"></div>
                </div>
            </div>
        </div>
        <!-- Section Indicateurs de Paiement -->
<div class="row mt-4">
    <div class="col-12">
        <div class="bg-light rounded p-4">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h6 class="mb-0">Indicateurs de Paiement</h6>
                <button class="btn btn-sm btn-outline-success" onclick="refreshPaymentData()">
                    <i class="fa fa-refresh me-1"></i>Actualiser
                </button>
            </div>
            
           <!-- Indicateurs principaux de paiement -->
<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="stat-card bg-success text-white d-flex flex-column justify-content-between rounded p-3 text-center h-100">
            <div>
                <i class="fa fa-check-circle fa-2x mb-2"></i>
                <h4 id="totalPaiementsComplets" class="mb-1">0</h4>
                <small>Paiements Complets</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-warning text-white d-flex flex-column justify-content-between rounded p-3 text-center h-100">
            <div>
                <i class="fa fa-clock-o fa-2x mb-2"></i>
                <h4 id="totalPaiementsPartiels" class="mb-1">0</h4>
                <small>Paiements Partiels</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-danger text-white d-flex flex-column justify-content-between rounded p-3 text-center h-100">
            <div>
                <i class="fa fa-times-circle fa-2x mb-2"></i>
                <h4 id="totalPaiementsImpaye" class="mb-1">0</h4>
                <small>Impay√©s</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-info text-white d-flex flex-column justify-content-between rounded p-3 text-center h-100">
            <div>
                <i class="fa fa-euro fa-2x mb-2"></i>
                <h4 id="totalMontantPercu" class="mb-1">0‚Ç¨</h4>
                <small>Montant Total Per√ßu</small>
            </div>
            <!-- üü¢ Nouveau conteneur align√© en bas -->
            <div id="montantParAbonnement" class="mt-3 text-start small bg-light text-dark p-2 rounded"></div>
        </div>
    </div>
</div>
<style>
    .stat-card {
    min-height: 150px; /* Hauteur minimale pour uniformiser */
}
#montantParAbonnement {
    font-size: 0.85rem;
    line-height: 1.4;
}

</style>
            
            <!-- Statistiques d√©taill√©es de paiement -->
            <div class="row g-3">
    <div class="col-md-4 d-flex">
        <div class="stat-card bg-white rounded shadow-sm p-3 d-flex flex-column justify-content-between w-100 h-100">
            <h6 class="mb-3">R√©partition par Type de R√®glement</h6>
            <div id="reglementStats" class="flex-grow-1"></div>
        </div>
    </div>
    <div class="col-md-4 d-flex">
        <div class="stat-card bg-white rounded shadow-sm p-3 d-flex flex-column justify-content-between w-100 h-100">
            <h6 class="mb-3">Status de Paiement par Type d'Abonnement</h6>
            <div id="paiementTypeAbonnementStats" class="flex-grow-1"></div>
        </div>
    </div>
    <div class="col-md-4 d-flex">
        <div class="stat-card bg-white rounded shadow-sm p-3 d-flex flex-column justify-content-between w-100 h-100">
            <h6 class="mb-3">Paiements R√©cents</h6>
            <div id="paiementsRecents" class="flex-grow-1 overflow-auto" style="max-height: 250px;"></div>
        </div>
    </div>
</div>
<style>
    .stat-card {
    min-height: 280px; /* m√™me hauteur pour toutes les cartes */
    display: flex;
    flex-direction: column;
}

#paiementsRecents {
    scrollbar-width: thin; 
    scrollbar-color: #ccc transparent;
}
#paiementsRecents::-webkit-scrollbar {
    width: 6px;
}
#paiementsRecents::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}

</style>
        </div>
    </div>
</div>

<script>
// Variables globales pour les paiements
let paiementsData = [];

// Charger les donn√©es de paiement au chargement initial
document.addEventListener('DOMContentLoaded', function() {
    // D√©lai pour laisser le temps aux adh√©rents de se charger
    setTimeout(() => {
        loadPaiementsData();
    }, 1000);
});

// Fonction pour charger les donn√©es des paiements
async function loadPaiementsData() {
    try {
        const response = await fetch('/api/paiements-indicators');
        const data = await response.json();
        
        if (data.success) {
            paiementsData = data.paiements;
            updatePaiementDisplay(data.statistics, data.montant_par_abonnement); // üü¢ modifi√©
            updateDetailedPaiementStats(data);
        } else {
            showPaiementError(data.error);
        }
    } catch (error) {
        showPaiementError('Erreur de connexion');
    }
}

// Mettre √† jour l'affichage principal des paiements
function updatePaiementDisplay(stats, montantParAbonnement) {
    document.getElementById('totalPaiementsComplets').textContent = stats.complets || 0;
    document.getElementById('totalPaiementsPartiels').textContent = stats.partiels || 0;
    document.getElementById('totalPaiementsImpaye').textContent = stats.impayes || 0;
    document.getElementById('totalMontantPercu').textContent = `${(stats.montant_total || 0).toLocaleString('fr-FR')}‚Ç¨`;

    // üü¢ Mise √† jour du d√©tail par type d'abonnement
    const container = document.getElementById('montantParAbonnement');
    container.innerHTML = '';
    if (montantParAbonnement && Object.keys(montantParAbonnement).length > 0) {
        Object.entries(montantParAbonnement).forEach(([type, montant]) => {
            container.innerHTML += `<div>${type}: <strong>${montant.toLocaleString('fr-FR')}‚Ç¨</strong></div>`;
        });
    } else {
        container.innerHTML = '<span class="text-muted">Aucun paiement</span>';
    }
}
// Mettre √† jour les statistiques d√©taill√©es
function updateDetailedPaiementStats(data) {
    // Stats par type de r√®glement
    updateReglementStats(data.reglement_stats);
    
    // Stats paiement par type d'abonnement
    updatePaiementTypeAbonnementStats(data.type_abonnement_payment_stats);
    
    // Paiements r√©cents
    updatePaiementsRecents(data.paiements_recents);
}

// Mettre √† jour les stats par type de r√®glement
function updateReglementStats(reglementStats) {
    const container = document.getElementById('reglementStats');
    container.innerHTML = '';
    
    if (!reglementStats || Object.keys(reglementStats).length === 0) {
        container.innerHTML = '<p class="text-muted">Aucun paiement enregistr√©</p>';
        return;
    }
    
    Object.entries(reglementStats).sort((a, b) => b[1] - a[1]).forEach(([type, count]) => {
        const total = Object.values(reglementStats).reduce((sum, val) => sum + val, 0);
        const percentage = ((count / total) * 100).toFixed(1);
        
        container.innerHTML += `
            <div class="d-flex justify-content-between mb-2">
                <span>${type || 'Non sp√©cifi√©'}:</span>
                <span><strong>${count}</strong> (${percentage}%)</span>
            </div>
        `;
    });
}

// Mettre √† jour les stats paiement par type d'abonnement
function updatePaiementTypeAbonnementStats(typeStats) {
    const container = document.getElementById('paiementTypeAbonnementStats');
    container.innerHTML = '';
    
    if (!typeStats || Object.keys(typeStats).length === 0) {
        container.innerHTML = '<p class="text-muted">Aucune donn√©es disponible</p>';
        return;
    }
    
    Object.entries(typeStats).forEach(([type, stats]) => {
        const total = stats.complets + stats.partiels + stats.impayes;
        if (total > 0) {
            container.innerHTML += `
                <div class="mb-3">
                    <strong>${type}</strong>
                    <div class="small">
                        <span class="text-success">‚úì ${stats.complets}</span> | 
                        <span class="text-warning">‚è≥ ${stats.partiels}</span> | 
                        <span class="text-danger">‚úó ${stats.impayes}</span>
                    </div>
                </div>
            `;
        }
    });
}

// Mettre √† jour les paiements r√©cents
function updatePaiementsRecents(paiementsRecents) {
    const container = document.getElementById('paiementsRecents');
    container.innerHTML = '';
    
    if (!paiementsRecents || paiementsRecents.length === 0) {
        container.innerHTML = '<p class="text-muted">Aucun paiement r√©cent</p>';
        return;
    }
    
    paiementsRecents.forEach(paiement => {
        const dateFormatted = new Date(paiement.date_paiement).toLocaleDateString('fr-FR');
        const statusClass = paiement.montant_reste <= 0 ? 'success' : 'warning';
        const statusText = paiement.montant_reste <= 0 ? 'Complet' : 'Partiel';
        
        container.innerHTML += `
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between">
                    <strong>${paiement.nom_adherent}</strong>
                    <span class="badge bg-${statusClass}">${statusText}</span>
                </div>
                <div class="small text-muted">
                    ${dateFormatted} - ${paiement.montant_paye}‚Ç¨/${paiement.montant}‚Ç¨
                </div>
            </div>
        `;
    });
}

// Afficher une erreur pour les paiements
function showPaiementError(error) {
    ['totalPaiementsComplets', 'totalPaiementsPartiels', 'totalPaiementsImpaye'].forEach(id => {
        document.getElementById(id).textContent = '?';
    });
    document.getElementById('totalMontantPercu').textContent = 'Erreur';
}

// Fonction pour actualiser les donn√©es de paiement
function refreshPaymentData() {
    const button = document.querySelector('button[onclick="refreshPaymentData()"]');
    const originalContent = button.innerHTML;
    
    button.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i>Chargement...';
    button.disabled = true;
    
    loadPaiementsData().finally(() => {
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}
</script>
    </div>
</div>
<!-- Adherents Indicators End -->

<script>
// Variables globales
let adherentsData = [];
let allAdherents = [];
let selectedTypes = new Set();
let selectedGroupes = new Set();

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    loadAdherentsData();
});

// Fonction pour √©chapper les caract√®res sp√©ciaux dans les identifiants
function escapeId(str) {
    return str.replace(/'/g, '_apostrophe_').replace(/\s+/g, '_space_').replace(/[^\w-]/g, '_');
}

// Fonction pour d√©coder les identifiants √©chapp√©s
function unescapeId(str) {
    return str.replace(/_apostrophe_/g, "'").replace(/_space_/g, ' ').replace(/_/g, ' ');
}

// Fonction pour charger les donn√©es des adh√©rents
async function loadAdherentsData() {
    try {
        const response = await fetch('/api/adherents-data');
        const data = await response.json();
        
        if (data.success) {
            allAdherents = data.adherents;
            adherentsData = [...allAdherents];
            
            // Debug: afficher les informations d√©taill√©es dans la console
            console.log('=== DEBUG ADHERENTS D√âTAILL√â ===');
            console.log(`Total en DB: ${data.debug_info.total_in_db}`);
            console.log(`Total trait√©: ${data.debug_info.total_processed}`);
            console.log('√âchantillon brut:', data.debug_info.raw_sample);
            console.log('Types d\'abonnement uniques:', data.types_abonnement);
            console.log('Groupes uniques:', data.groupes);
            console.log('Tous les adh√©rents trait√©s:');
            data.adherents.forEach((adh, index) => {
                console.log(`  ${index + 1}. ID:${adh.id} | Type:"${adh.type_abonnement}" | Groupe:"${adh.groupe}" | Nom:"${adh.nom}"`);
            });
            
            // V√©rification des comptages
            const typeCount = {};
            const groupeCount = {};
            data.adherents.forEach(adh => {
                typeCount[adh.type_abonnement] = (typeCount[adh.type_abonnement] || 0) + 1;
                groupeCount[adh.groupe] = (groupeCount[adh.groupe] || 0) + 1;
            });
            console.log('Comptage par type:', typeCount);
            console.log('Comptage par groupe:', groupeCount);
            
            // G√©n√©rer les filtres
            generateTypeFilters(data.types_abonnement);
            generateGroupeFilters(data.groupes);
            
            // Mettre √† jour l'affichage
            updateDisplay();
        } else {
            console.error('Erreur lors du chargement des donn√©es:', data.error);
            // Afficher l'erreur dans l'interface
            document.getElementById('totalAdherents').textContent = 'Erreur';
            document.getElementById('filterStatus').textContent = data.error;
        }
    } catch (error) {
        console.error('Erreur de connexion:', error);
        document.getElementById('totalAdherents').textContent = 'Erreur';
        document.getElementById('filterStatus').textContent = 'Erreur de connexion';
    }
}

// G√©n√©rer les filtres pour les types d'abonnement (VERSION CORRIG√âE)
function generateTypeFilters(types) {
    const container = document.getElementById('typeAbonnementFilters');
    container.innerHTML = '';
    
    types.forEach(type => {
        const div = document.createElement('div');
        div.className = 'form-check form-check-inline';
        
        // √âchapper l'identifiant pour √©viter les probl√®mes avec les apostrophes
        const escapedType = escapeId(type);
        
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" id="type_${escapedType}" 
                   data-original-value="${type}" onchange="toggleTypeFilter(this)">
            <label class="form-check-label" for="type_${escapedType}">
                ${type}
            </label>
        `;
        container.appendChild(div);
    });
}

// G√©n√©rer les filtres pour les groupes (VERSION CORRIG√âE)
function generateGroupeFilters(groupes) {
    const container = document.getElementById('groupeFilters');
    container.innerHTML = '';
    
    groupes.forEach(groupe => {
        const div = document.createElement('div');
        div.className = 'form-check form-check-inline';
        
        // √âchapper l'identifiant pour √©viter les probl√®mes avec les apostrophes
        const escapedGroupe = escapeId(groupe);
        
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" id="groupe_${escapedGroupe}" 
                   data-original-value="${groupe}" onchange="toggleGroupeFilter(this)">
            <label class="form-check-label" for="groupe_${escapedGroupe}">
                ${groupe}
            </label>
        `;
        container.appendChild(div);
    });
}

// Basculer le filtre de type d'abonnement (VERSION CORRIG√âE)
function toggleTypeFilter(checkbox) {
    const type = checkbox.getAttribute('data-original-value');
    
    if (checkbox.checked) {
        selectedTypes.add(type);
        console.log(`Type ajout√©: "${type}"`);
    } else {
        selectedTypes.delete(type);
        console.log(`Type retir√©: "${type}"`);
    }
    
    console.log('Types s√©lectionn√©s:', Array.from(selectedTypes));
    applyFilters();
}

// Basculer le filtre de groupe (VERSION CORRIG√âE)
function toggleGroupeFilter(checkbox) {
    const groupe = checkbox.getAttribute('data-original-value');
    
    if (checkbox.checked) {
        selectedGroupes.add(groupe);
        console.log(`Groupe ajout√©: "${groupe}"`);
    } else {
        selectedGroupes.delete(groupe);
        console.log(`Groupe retir√©: "${groupe}"`);
    }
    
    console.log('Groupes s√©lectionn√©s:', Array.from(selectedGroupes));
    applyFilters();
}

// Appliquer les filtres (VERSION AM√âLIOR√âE AVEC DEBUG)
function applyFilters() {
    console.log('=== D√âBUT FILTRAGE ===');
    console.log('Types s√©lectionn√©s:', Array.from(selectedTypes));
    console.log('Groupes s√©lectionn√©s:', Array.from(selectedGroupes));
    console.log('Nombre total d\'adh√©rents:', allAdherents.length);
    
    adherentsData = allAdherents.filter(adherent => {
        const typeMatch = selectedTypes.size === 0 || selectedTypes.has(adherent.type_abonnement);
        const groupeMatch = selectedGroupes.size === 0 || selectedGroupes.has(adherent.groupe);
        
        const result = typeMatch && groupeMatch;
        
        if (selectedTypes.size > 0 || selectedGroupes.size > 0) {
            console.log(`Adh√©rent "${adherent.nom}": type="${adherent.type_abonnement}" (${typeMatch}), groupe="${adherent.groupe}" (${groupeMatch}) => ${result ? 'INCLUS' : 'EXCLU'}`);
        }
        
        return result;
    });
    
    console.log('Nombre d\'adh√©rents filtr√©s:', adherentsData.length);
    console.log('=== FIN FILTRAGE ===');
    
    updateDisplay();
}

// Mettre √† jour l'affichage
function updateDisplay() {
    // Mettre √† jour le nombre total
    document.getElementById('totalAdherents').textContent = adherentsData.length;
    
    // Mettre √† jour le statut du filtre
    updateFilterStatus();
    
    // Mettre √† jour les statistiques d√©taill√©es
    updateDetailedStats();
}

// Mettre √† jour le statut du filtre
function updateFilterStatus() {
    const statusElement = document.getElementById('filterStatus');
    const totalFilters = selectedTypes.size + selectedGroupes.size;
    
    if (totalFilters === 0) {
        statusElement.textContent = 'Tous les adh√©rents';
    } else {
        const filters = [];
        if (selectedTypes.size > 0) {
            filters.push(`${selectedTypes.size} type(s)`);
        }
        if (selectedGroupes.size > 0) {
            filters.push(`${selectedGroupes.size} groupe(s)`);
        }
        statusElement.textContent = `Filtr√© par: ${filters.join(', ')}`;
    }
}

// Mettre √† jour les statistiques d√©taill√©es
function updateDetailedStats() {
    updateTypeStats();
    updateGroupeStats();
}

// Mettre √† jour les stats par type
function updateTypeStats() {
    const typeCount = {};
    adherentsData.forEach(adherent => {
        typeCount[adherent.type_abonnement] = (typeCount[adherent.type_abonnement] || 0) + 1;
    });
    
    const container = document.getElementById('typeStats');
    container.innerHTML = '';
    
    Object.entries(typeCount).sort((a, b) => b[1] - a[1]).forEach(([type, count]) => {
        const percentage = ((count / adherentsData.length) * 100).toFixed(1);
        container.innerHTML += `
            <div class="d-flex justify-content-between mb-2">
                <span>${type}:</span>
                <span><strong>${count}</strong> (${percentage}%)</span>
            </div>
        `;
    });
}

// Mettre √† jour les stats par groupe
function updateGroupeStats() {
    const groupeCount = {};
    adherentsData.forEach(adherent => {
        groupeCount[adherent.groupe] = (groupeCount[adherent.groupe] || 0) + 1;
    });
    
    const container = document.getElementById('groupeStats');
    container.innerHTML = '';
    
    Object.entries(groupeCount).sort((a, b) => b[1] - a[1]).forEach(([groupe, count]) => {
        const percentage = ((count / adherentsData.length) * 100).toFixed(1);
        container.innerHTML += `
            <div class="d-flex justify-content-between mb-2">
                <span>${groupe}:</span>
                <span><strong>${count}</strong> (${percentage}%)</span>
            </div>
        `;
    });
}

// R√©initialiser tous les filtres (VERSION CORRIG√âE)
function resetFilters() {
    // D√©cocher toutes les checkboxes
    document.querySelectorAll('#typeAbonnementFilters input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    document.querySelectorAll('#groupeFilters input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Vider les sets
    selectedTypes.clear();
    selectedGroupes.clear();
    
    console.log('Filtres r√©initialis√©s');
    
    // R√©appliquer les filtres (tous les adh√©rents)
    applyFilters();
}
</script>
<!-- Charts Start -->
<div class="container-fluid pt-4 ">
    <div class="row g-4">
        <!-- Chart existants -->
        <div class="col-sm-12 col-xl-6">
            <div class="bg-light text-center rounded p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">R√©partition des Paiements</h6>
                    <a href="javascript:void(0);" onclick="downloadChart('typePaiementChart')">T√©l√©charger</a>
                </div>
                <canvas id="typePaiementChart"></canvas>
            </div>
        </div>
        
        <div class="col-sm-12 col-xl-6">
            <div class="bg-light text-center rounded p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">Collecte par Saison</h6>
                    <div class="form-check">
                        
                        
                    </div>
                </div>
                <canvas id="saisonChart"></canvas>
            </div>
        </div>

        <!-- Nouveaux charts -->
        <div class="col-12">
            <div class="bg-light rounded p-4">
                <div class="d-flex justify-content-between mb-4">
                    <h6 class="mb-0">√âvolution Mensuelle des Paiements</h6>
                    <div class="btn-group">
                       
                    </div>
                </div>
                <canvas id="monthlyTrendChart"></canvas>
            </div>
        </div>

        <div class="col-sm-12 col-xl-8">
            <div class="bg-light text-center rounded p-4">
                <h6 class="mb-4">Top 10 Adh√©rents</h6>
                <canvas id="topAdherentsChart"></canvas>
            </div>
        </div>

        <div class="col-sm-12 col-xl-4">
            <div class="bg-light rounded p-4">
                <h6 class="mb-4">Statut des Paiements Saison Actuelle</h6>
                <div id="paymentStatusGauge" class="gauge-container"></div>
                <div class="mt-3">
                    <span class="badge bg-success">Pay√©: <span id="paidAmount">0</span> TND</span>
                    <span class="badge bg-danger ms-2">Reste: <span id="remainingAmount">0</span> TND</span>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .gauge-container {
    position: relative;
    width: 200px;
    height: 200px;
    margin: 0 auto;
}

.gauge {
    transform: rotate(-90deg);
    transform-origin: 50% 50%;
}

.gauge-circle {
    fill: none;
    stroke-width: 10;
}

.gauge-background {
    stroke: #eee;
}

.gauge-progress {
    stroke: #4CAF50;
    transition: stroke-dashoffset 0.5s;
}

.chart-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    pointer-events: none;
    font-size: 0.9em;
}
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Configuration globale
    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.color = '#666';

    // Initialisation des charts
    initPaymentTypeChart();
    initSaisonChart();
    initMonthlyTrendChart();
    initTopAdherentsChart();
    initPaymentGauge();


    // Gestion des ann√©es pour le trend chart
    document.querySelectorAll('.btn-group button').forEach(button => {
        button.addEventListener('click', function() {
            const year = this.dataset.year;
            updateMonthlyTrendChart(year);
            document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
});

// Fonctions d'initialisation des charts
async function initPaymentTypeChart() {
    const response = await fetch('/stats/payment-types');
    const data = await response.json();
    
    new Chart(document.getElementById('typePaiementChart'), {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: [
                    '#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f'
                ],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.label}: ${context.raw.toFixed(2)} TND `
                    }
                }
            }
        }
    });
}

async function initSaisonChart() {
    const response = await fetch('/stats/saisons');
    const data = await response.json();
    
    window.saisonChart = new Chart(document.getElementById('saisonChart'), {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Montant Collect√©',
                data: data.values,
                backgroundColor: 'rgba(78, 121, 167, 0.8)',
                borderColor: '#4e79a7',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { stacked: false },
                y: {
                    stacked: false,
                    beginAtZero: true,
                    ticks: { callback: value => `${value} TND` }
                }
            },
            plugins: {
                annotation: {
                    annotations: {
                        avgLine: {
                            type: 'line',
                            yMin: data.average,
                            yMax: data.average,
                            borderColor: '#e15759',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: `Moyenne: ${data.average.toFixed(2)} TND`,
                                position: 'end'
                            }
                        }
                    }
                }
            }
        }
    });
}

// Fonction pour le gauge de statut de paiement
async function initPaymentGauge() {
    const response = await fetch('/stats/payment-status');
    const data = await response.json();
    
    const gauge = document.getElementById('paymentStatusGauge');
    gauge.innerHTML = `
        <svg class="gauge" viewBox="0 0 100 100">
            <circle class="gauge-circle gauge-background" cx="50" cy="50" r="45"/>
            <circle class="gauge-circle gauge-progress" cx="50" cy="50" r="45" 
                    stroke-dasharray="${2 * Math.PI * 45}" 
                    stroke-dashoffset="${2 * Math.PI * 45 * (1 - data.paidPercentage)}"/>
        </svg>
    `;
    
    document.getElementById('paidAmount').textContent = data.totalPaid.toFixed(2);
    document.getElementById('remainingAmount').textContent = data.totalRemaining.toFixed(2);
}

// Fonction de t√©l√©chargement
function downloadChart(chartId) {
    const canvas = document.getElementById(chartId);
    const link = document.createElement('a');
    link.download = `${chartId}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
}

async function initMonthlyTrendChart(year = new Date().getFullYear()) {
    const response = await fetch(`/stats/monthly-trend/${year}`);
    const data = await response.json();
    
    window.monthlyTrendChart = new Chart(document.getElementById('monthlyTrendChart'), {
        type: 'line',
        data: {
            labels: data.months.map(m => new Date(2000, m - 1).toLocaleString('default', { month: 'long' })),
            datasets: [{
                label: 'Montant Collect√©',
                data: data.amounts,
                borderColor: '#4e79a7',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(78, 121, 167, 0.1)'
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.dataset.label}: ${context.raw.toFixed(2)} TND`
                    }
                }
            }
        }
    });
}

async function initTopAdherentsChart() {
    const response = await fetch('/stats/top-adherents');
    const data = await response.json();
    
    new Chart(document.getElementById('topAdherentsChart'), {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Total Pay√©',
                data: data.values,
                backgroundColor: data.colors
            }]
        },
        options: {
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
}
</script>
<!-- Charts End -->

<!-- Recent Payments Start -->
<div class="container-fluid pt-4 px-4">
    <div class="bg-light text-center rounded p-4">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h6 class="mb-0">Derniers Paiements</h6>
            <a href="/recherche-paiements">Voir tous</a>
        </div>
        <div class="table-responsive">
            <table class="table text-start align-middle table-bordered table-hover mb-0">
                <thead>
                    <tr class="text-dark">
                        <th scope="col">Date</th>
                        <th scope="col">Matricule</th>
                        <th scope="col">Montant Pay√©</th>
                        <th scope="col">Type</th>
                        <th scope="col">Saison</th>
                        <th scope="col">D√©tails</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in paiements_recent %}
                    <tr>
                        <td>{{ p.date_paiement.strftime('%d/%m/%Y') }}</td>
                        <td>{{ p.matricule_adherent }}</td>
                        <td>{{ p.montant_paye }} TND</td>
                        <td>{{ p.type_reglement or 'Non sp√©cifi√©' }}</td>
                        <td>{{ p.code_saison }}</td>
                        <td><a class="btn btn-sm btn-primary" href="/static/bons_paiements/paiement_{{p.numero_bon}}.pdf">D√©tails üßæ</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Recent Payments End -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



            <!-- Footer Start -->
            <div class="container-fluid pt-4 px-4">
                <div class="bg-light rounded-top p-4">
                    <div class="row">
                        <div class="col-12 col-sm-6 text-center text-sm-start">
                            &copy; <a href="#">TCHS</a>, All Right Reserved. 
                        </div>
                        <div class="col-12 col-sm-6 text-center text-sm-end">
                            <!--/*** This template is free as long as you keep the footer author‚Äôs credit link/attribution link/backlink. If you'd like to use the template without the footer author‚Äôs credit link/attribution link/backlink, you can purchase the Credit Removal License from "https://htmlcodex.com/credit-removal". Thank you for your support. ***/-->
                            Designed by <a>AMH</a>
                        </br>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer End -->
        </div>
        <!-- Content End -->


        <!-- Back to Top -->
        <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
    

    <!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='lib/chart/chart.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/easing/easing.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/waypoints/waypoints.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/owlcarousel/owl.carousel.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/tempusdominus/js/moment.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/tempusdominus/js/moment-timezone.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js') }}"></script>

<!-- Template Javascript -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>

</html>