<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>TCHS</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="{{ url_for('static', filename='img/favicon.ico') }}" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="{{ url_for('static', filename='lib/owlcarousel/assets/owl.carousel.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css') }}" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>
     <style>
        .input-group {
            height: 58px;
        }
        .input-group .form-select, 
        .input-group .form-control {
            height: 100%;
        }
        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .text-primary {
            font-weight: 600;
        }
    </style>
    <div class="content">
    {% include 'sidebar.html' %}
    <!-- Navbar Start -->
            <nav class="navbar navbar-expand bg-light navbar-light sticky-top px-4 py-0">
                <a href="index.html" class="navbar-brand d-flex d-lg-none me-4">
                    <h2 class="text-primary mb-0"></h2>
                </a>
                <a href="#" class="sidebar-toggler flex-shrink-0">
                    <i class="fa fa-bars"></i>
                </a>

                

                

                
            </nav>
            <!-- Navbar End -->
    <div class="container-xxl position-relative bg-white d-flex p-0">
        <!-- Sign In Start -->
        <div class="container-fluid">
            <div class="row h-100 align-items-center justify-content-center" style="min-height: 100vh;">
                <div class="col-12 col-sm-8 col-md-6 col-lg-5 col-xl-4">
                    <div class="">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <a href="{{ url_for('admin') }}">
                                <h3 class="text-primary text-center">TCHS.</h3>
                            </a>
                        </div>
                        <form method="post" action="{{ url_for('ajouter_adherent') }}">
                            <!-- Conteneur pour le message d'erreur -->
                            <div id="error-message" style="color: red; margin-bottom: 15px; display: none;"></div>
                        
                            <div class="row">
                                <!-- Nouveau champ Code Saison -->
                                <div class="col-6">
                                    <div class="form-floating mb-3">
                                        <label for="code_saison">Code Saison<span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <select id="prefix_saison" class="form-select" style="flex: 0 0 30%;">
                                                <option value="S">S (Saison)</option>
                                                <option value="E">E (École d'été)</option>
                                            </select>
                                            <input type="number" id="annee_saison" class="form-control" min="2020" max="2050" step="1" style="flex: 1;">
                                            <input type="hidden" id="code_saison" name="code_saison" required>
                                        </div>
                                        <small class="form-text text-muted">Code généré automatiquement: <span id="code-saison-preview" class="text-primary font-weight-bold">{{ code_saison_defaut }}</span></small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="floatingInput" name="Nom" placeholder="Nom" required>
                                        <label for="floatingInput">Nom <span class="text-danger">*</span></label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="floatingInput" name="Prénom" placeholder="Prénom" required>
                                        <label for="floatingInput">Prénom<span class="text-danger">*</span></label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-floating mb-3">
                                        <input type="date" class="form-control" id="floatingInput" name="date_naissance" placeholder="Date de Naissance" required>
                                        <label for="floatingInput">Date de Naissance<span class="text-danger">*</span></label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="floatingInput" name="tel1" placeholder="Téléphone 1" required>
                                        <label for="floatingInput">Téléphone 1<span class="text-danger">*</span></label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="floatingInput" name="tel2" placeholder="Téléphone 2">
                                        <label for="floatingInput">Téléphone 2</label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form mb-3">
                                        <label for="type_abonnement">Type d'abonnement<span class="text-danger">*</span></label>
                                        <select id="type_abonnement" name="type_abonnement" class="form-control" required>
                                            <option value="" disabled selected>Choisissez un type d'abonnement</option>
                                            <option value="Compétitif">Compétitif</option>
                                            <option value="Non Compétitif">Non Compétitif</option>
                                            <option value="Pré-Compétitif">Pré-Compétitif</option>
                                            <option value="Ecole d'été">Ecole d'été</option>
                                            <option value="Loisir">Loisir</option>
                                            <option value="N/D">N/D</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-6">
                                    <div class="form mb-3">
                                        <label for="ancien_abonne">Ancien Abonné</label>
                                        <select id="ancien_abonne" name="ancien_abonne" class="form-control" required>
                                            <option value="" disabled selected>Choisissez une option</option>
                                            <option value="Oui">Oui</option>
                                            <option value="Non">Non</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-6">
                                    <div class="form mb-3">
                                        <label for="groupe">Groupe</label>
                                        <input list="groupes" name="groupe" id="groupe" class="form-control" >
                                        <datalist id="groupes">
                                            {% for groupe in groupes %}
                                                <option value="{{ groupe.nom_groupe }}" data-abonnement="{{ groupe.type_abonnement }}">
                                                    {{ groupe.nom_groupe }} ({{ groupe.type_abonnement }})
                                                </option>
                                            {% endfor %}
                                        </datalist>
                                    </div>
                                </div>
                                
                                <div class="col-6">
                                    <div class="form mb-3">
                                        <label for="entraineur">Entraîneur</label>
                                        <select id="entraineur" name="entraineur" class="form-control" >
                                            
                                            <option value="" data-abonnement=""></option>
                                               
                                            </option>
                                            {% for e in entraineurs %}
                                                <option value="{{ e.nom }} {{ e.prenom }}" data-abonnement="{{ e.type_abonnement }}">
                                                    {{ e.nom }} {{ e.prenom }} ({{ e.type_abonnement }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-floating mb-3">
                                        <input type="email" class="form-control" id="floatingInput" name="email" placeholder="Email">
                                        <label for="floatingInput">Email</label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form mb-3">
                                        <label for="sexe">Sexe<span class="text-danger">*</span></label>
                                        <select id="sexe" name="sexe" class="form-control" required>
                                            <option value="" disabled selected>Choisissez une option</option>
                                            <option value="M">Masculin</option>
                                            <option value="F">Feminin</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-floating mb-3">
                                        <input type="date" class="form-control" id="floatingInput" name="date_inscription" placeholder="Date d'inscription" required>
                                        <label for="floatingInput">Date d'inscription<span class="text-danger">*</span></label>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary py-3 w-100 mb-4">Ajouter Adherent</button>
                        </form>
                        
                    </div>
                </div>
            </div>
        </div>
        <!-- Sign In End -->
    </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const typeAbonnementSelect = document.getElementById('type_abonnement');
            const entraineurSelect = document.getElementById('entraineur');
            const groupeInput = document.getElementById('groupe');
            const groupesDatalist = document.getElementById('groupes');
            const errorMessage = document.getElementById('error-message');
            const form = document.querySelector('form');
            
            // Éléments pour le code saison
            const prefixSaison = document.getElementById('prefix_saison');
            const anneeSaison = document.getElementById('annee_saison');
            const codeSaisonHidden = document.getElementById('code_saison');
            const codeSaisonPreview = document.getElementById('code-saison-preview');
            
            // Fonction pour générer le code saison automatiquement
            function genererCodeSaisonAuto() {
                const aujourd_hui = new Date();
                const mois = aujourd_hui.getMonth() + 1; // getMonth() retourne 0-11
                const annee = aujourd_hui.getFullYear();
                
                let prefix, anneeCode;
                
                if (mois >= 10) { // Octobre à décembre - début de saison
                    prefix = 'S';
                    anneeCode = annee + 1;
                } else if (mois >= 6 && mois <= 8) { // Juin à août - école d'été
                    prefix = 'E';
                    anneeCode = annee;
                } else { // Janvier à mai - fin de saison
                    prefix = 'S';
                    anneeCode = annee;
                }
                
                return { prefix, anneeCode };
            }
            
            // Initialiser les valeurs par défaut
            function initialiserCodeSaison() {
                const codeAuto = genererCodeSaisonAuto();
                prefixSaison.value = codeAuto.prefix;
                anneeSaison.value = codeAuto.anneeCode;
                mettreAJourCodeSaison();
            }
            
            // Mettre à jour le code saison
            function mettreAJourCodeSaison() {
                const prefix = prefixSaison.value;
                const annee = anneeSaison.value;
                const codeFinal = prefix + annee;
                
                codeSaisonHidden.value = codeFinal;
                codeSaisonPreview.textContent = codeFinal;
            }
            
            // Validation cohérence type abonnement/code saison
            function validerCoherenceSaison() {
                const typeAbonnement = typeAbonnementSelect.value;
                const prefix = prefixSaison.value;
                
                if (typeAbonnement === 'Ecole d\'été' && prefix !== 'E') {
                    errorMessage.innerText += "Pour l'école d'été, utilisez le préfixe 'E'.\n";
                    errorMessage.style.display = 'block';
                    return false;
                }
                
                return true;
            }

            function validateAbonnement() {
                const selectedAbonnement = typeAbonnementSelect.value;
                const selectedEntraineur = entraineurSelect.options[entraineurSelect.selectedIndex];
                const groupeValue = groupeInput.value;

                errorMessage.style.display = 'none';
                errorMessage.innerText = '';
                let isValid = true;

                // Vérifier le type d'abonnement de l'entraîneur
                if (selectedEntraineur) {
                    const entraineurAbonnement = selectedEntraineur.getAttribute('data-abonnement');
                    if (entraineurAbonnement && entraineurAbonnement !== selectedAbonnement) {
                        isValid = false;
                        errorMessage.innerText += "Le type d'abonnement de l'entraîneur ne correspond pas.\n";
                    }
                }

                // Vérifier le type d'abonnement du groupe
                if (groupesDatalist) {
                    const groupeOption = Array.from(groupesDatalist.options).find(option => option.value === groupeValue);
                    if (groupeOption) {
                        const groupeAbonnement = groupeOption.getAttribute('data-abonnement');
                        if (groupeAbonnement && groupeAbonnement !== selectedAbonnement) {
                            isValid = false;
                            errorMessage.innerText += "Le type d'abonnement du groupe ne correspond pas.\n";
                        }
                    }
                }
                
                // Vérifier la cohérence avec le code saison
                if (!validerCoherenceSaison()) {
                    isValid = false;
                }

                if (!isValid) {
                    errorMessage.style.display = 'block';
                }
                return isValid;
            }
            
            // Initialiser le code saison au chargement
            initialiserCodeSaison();
            
            // Event listeners
            prefixSaison.addEventListener('change', function() {
                mettreAJourCodeSaison();
                validateAbonnement();
            });
            
            anneeSaison.addEventListener('input', function() {
                mettreAJourCodeSaison();
            });
            
            typeAbonnementSelect.addEventListener('change', function() {
                // Auto-ajuster le préfixe pour l'école d'été
                if (this.value === 'Ecole d\'été') {
                    prefixSaison.value = 'E';
                    mettreAJourCodeSaison();
                }
                validateAbonnement();
            });
            
            entraineurSelect.addEventListener('change', validateAbonnement);
            groupeInput.addEventListener('input', validateAbonnement);
            
            // Bouton pour réinitialiser au code automatique
            const resetButton = document.createElement('button');
            resetButton.type = 'button';
            resetButton.className = 'btn btn-sm btn-outline-secondary mt-1';
            resetButton.textContent = 'Auto';
            resetButton.title = 'Générer automatiquement selon la date actuelle';
            resetButton.onclick = initialiserCodeSaison;
            
            document.querySelector('#code_saison').parentNode.appendChild(resetButton);
        });
    </script>
    
    <!-- JavaScript Libraries -->
    <script src="{{ url_for('static', filename='lib/chart/chart.min.js') }}" rel="stylesheet"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='lib/chart/chart.min.js') }}" rel="stylesheet"></script>
    <script src="{{ url_for('static', filename='lib/easing/easing.min.js') }}" rel="stylesheet"></script>
    <script src="{{ url_for('static', filename='lib/waypoints/waypoints.min.js') }}" rel="stylesheet"></script>
    <script src="{{ url_for('static', filename='lib/owlcarousel/owl.carousel.min.js') }}" rel="stylesheet"></script>
    <script src="{{ url_for('static', filename='lib/tempusdominus/js/moment.min.js') }}" rel="stylesheet"></script>
    <script src="{{ url_for('static', filename='lib/tempusdominus/js/moment-timezone.min.js') }}" rel="stylesheet"></script>
    <script src="{{ url_for('static', filename='lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js') }}" rel="stylesheet"></script>

    <!-- Template Javascript -->
    <script src="{{ url_for('static', filename='js/main.js') }}" rel="stylesheet"></script>
</body>

</html>