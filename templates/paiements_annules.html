<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Paiements Annulés - TCHS</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}?v=2">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Libraries -->
    <link href="{{ url_for('static', filename='lib/owlcarousel/assets/owl.carousel.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css') }}" rel="stylesheet">
    
    <!-- Bootstrap & Template -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    
    <style>
        .paiement-annule-row {
            background-color: #f8d7da !important;
            opacity: 0.9;
        }
        
        .paiement-annule-row:hover {
            background-color: #f5c6cb !important;
            opacity: 1;
        }
        
        .badge-annule {
            background-color: #dc3545;
            color: white;
        }
        
        .table-responsive {
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .export-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .export-btn:hover {
            background-color: #218838;
        }
    </style>
</head>

<body>
    {% include 'sidebar.html' %}
    
    <div class="content">
        <nav class="navbar navbar-expand bg-light navbar-light sticky-top px-4 py-0">
            <a href="index.html" class="navbar-brand d-flex d-lg-none me-4">
                <h2 class="text-primary mb-0"></h2>
            </a>
            <a href="#" class="sidebar-toggler flex-shrink-0">
                <i class="fa fa-bars"></i>
            </a>
        </nav>

        <div class="container-xxl position-relative bg-white d-flex p-0">
            <div class="container mt-5">
                {% if saison_type == 'ete' %}
                    <h1 class="mb-4">Paiements Annulés - École d'Été {{ saison_year }}</h1>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Vous consultez les paiements annulés pour la saison <strong>{{ code_saison }}</strong> (École d'Été)
                    </div>
                {% else %}
                    <h1 class="mb-4">Paiements Annulés - Abonnements Annuels {{ saison_year - 1 }}/{{ saison_year }}</h1>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Vous consultez les paiements annulés pour la saison <strong>{{ code_saison }}</strong> (Abonnement Annuel)
                    </div>
                {% endif %}
                
                <!-- Carte de statistiques -->
                <div class="row">
                    <div class="col-12">
                        <div class="stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="mb-1"><i class="bi bi-x-circle me-2"></i>{{ total_annules }} Paiement(s) Annulé(s)</h3>
                                    <p class="mb-0">Total des transactions annulées pour cette saison</p>
                                </div>
                                <div class="text-end">
                                    <button class="export-btn" onclick="exporterPaiementsAnnules()">
                                        <i class="bi bi-download me-2"></i>Exporter en CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tableau des paiements annulés -->
                <div class="card shadow-sm border-0 rounded-3">
                    <div class="card-header bg-danger text-white py-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-x-octagon me-2"></i>Liste des Paiements Annulés
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date Annulation</th>
                                        <th>Adhérent</th>
                                        <th>Matricule</th>
                                        <th>Date Paiement</th>
                                        <th>Saison</th>
                                        <th>N° Carnet</th>
                                        <th>N° Bon</th>
                                        <th>Montant Payé</th>
                                        <th>Type Règlement</th>
                                        <th>N° Chèque</th>
                                        <th>Banque</th>
                                        <th>Cotisation</th>
                                        <th>Remise</th>
                                        <th>Annulé par</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if paiements_data %}
                                        {% for data in paiements_data %}
                                        <tr class="paiement-annule-row">
                                            <td>
                                                {% if data.paiement.date_annulation %}
                                                    {{ data.paiement.date_annulation.strftime('%d/%m/%Y %H:%M') }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td><strong>{{ data.adherent_nom }}</strong></td>
                                            <td><span class="badge bg-info">{{ data.adherent_matricule }}</span></td>
                                            <td>{{ data.paiement.date_paiement.strftime('%d/%m/%Y') }}</td>
                                            <td><span class="badge bg-secondary">{{ data.paiement.code_saison }}</span></td>
                                            <td>{{ data.paiement.numero_carnet }}</td>
                                            <td>{{ data.paiement.numero_bon }}</td>
                                            <td><strong class="text-danger">{{ "%.2f"|format(data.paiement.montant_paye) }} TND</strong></td>
                                            <td>
                                                {% if data.paiement.type_reglement == 'espèce' %}
                                                    <span class="badge bg-success">Espèce</span>
                                                {% elif data.paiement.type_reglement == 'chèque' %}
                                                    <span class="badge bg-warning text-dark">Chèque</span>
                                                {% else %}
                                                    <span class="badge bg-primary">Virement</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ data.paiement.numero_cheque or '-' }}</td>
                                            <td>{{ data.paiement.banque or '-' }}</td>
                                            <td>{{ "%.2f"|format(data.paiement.cotisation) }} TND</td>
                                            <td>{{ data.paiement.remise }}%</td>
                                            <td>
                                                <span class="badge bg-dark">{{ data.paiement.annule_par or 'Système' }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="14" class="text-center py-4">
                                                <div class="text-muted">
                                                    <i class="bi bi-check-circle display-4 text-success"></i>
                                                    <h4 class="mt-3">Aucun paiement annulé</h4>
                                                    <p>Aucun paiement n'a été annulé pour cette saison.</p>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="7" class="text-end"><strong>Total Montant Annulé :</strong></td>
                                        <td colspan="7">
                                            <strong class="text-danger">
                                                {{ "%.2f"|format(paiements_data | sum(attribute='paiement.montant_paye')) }} TND
                                            </strong>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Informations supplémentaires -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <h6><i class="bi bi-exclamation-triangle me-2"></i>Informations</h6>
                            <ul class="mb-0">
                                <li>Les paiements annulés ne sont pas pris en compte dans les calculs financiers</li>
                                <li>L'historique des annulations est conservé à des fins de traçabilité</li>
                                <li>Seuls les administrateurs peuvent annuler des paiements</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-clock-history me-2"></i>Dernières Annulations</h6>
                            {% if paiements_data %}
                                <ul class="mb-0">
                                    {% for data in paiements_data[:3] %}
                                    <li>
                                        <strong>{{ data.adherent_nom }}</strong> - 
                                        {{ "%.2f"|format(data.paiement.montant_paye) }} TND - 
                                        {% if data.paiement.date_annulation %}
                                            {{ data.paiement.date_annulation.strftime('%d/%m/%Y') }}
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="mb-0">Aucune annulation récente</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='lib/chart/chart.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/easing/easing.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/waypoints/waypoints.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/owlcarousel/owl.carousel.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/tempusdominus/js/moment.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/tempusdominus/js/moment-timezone.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js') }}"></script>

    <!-- Template Javascript -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
        // Fonction pour exporter les paiements annulés en CSV
// Fonction pour exporter les paiements annulés en CSV avec bon encodage
function exporterPaiementsAnnules() {
    // Créer le contenu CSV avec encodage UTF-8 et BOM
    const BOM = '\uFEFF';
    let csvContent = BOM + "Date Annulation;Adhérent;Matricule;Date Paiement;Saison;N° Carnet;N° Bon;Montant Payé;Type Règlement;N° Chèque;Banque;Cotisation;Remise;Annulé par\n";
    
    // Ajouter les données avec point-virgule comme séparateur
    {% for data in paiements_data %}
    csvContent += `"{% if data.paiement.date_annulation %}{{ data.paiement.date_annulation.strftime('%d/%m/%Y %H:%M') }}{% else %}-{% endif %}";"{{ data.adherent_nom }}";"{{ data.adherent_matricule }}";"{{ data.paiement.date_paiement.strftime('%d/%m/%Y') }}";"{{ data.paiement.code_saison }}";"{{ data.paiement.numero_carnet }}";"{{ data.paiement.numero_bon }}";"{{ "%.2f"|format(data.paiement.montant_paye) }}";"{{ data.paiement.type_reglement }}";"{{ data.paiement.numero_cheque or '-' }}";"{{ data.paiement.banque or '-' }}";"{{ "%.2f"|format(data.paiement.cotisation) }}";"{{ data.paiement.remise }}%";"{{ data.paiement.annule_par or 'Système' }}"` + "\n";
    {% endfor %}
    
    // Créer et télécharger le fichier avec le bon type MIME
    const blob = new Blob([csvContent], { 
        type: 'text/csv;charset=utf-8;' 
    });
    
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `paiements_annules_{{ code_saison }}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Afficher un message de confirmation
    setTimeout(() => {
        alert(`Export réussi ! Fichier: paiements_annules_{{ code_saison }}_${new Date().toISOString().split('T')[0]}.csv\n\nOuvrez le fichier avec Excel en sélectionnant l'encodage UTF-8 si nécessaire.`);
    }, 100);
}
        // Tri des tableaux
        document.addEventListener('DOMContentLoaded', function() {
            // Ajouter des fonctionnalités de tri si nécessaire
            console.log('Page des paiements annulés chargée');
        });
    </script>
</body>
</html>